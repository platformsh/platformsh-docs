name: Auto-merge API doc updates

on:
  check_suite:
    types: [completed]
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success'
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.payload.check_suite.head_sha
            });

            if (prs.data.length === 0) {
              console.log('No PR found for this commit');
              return null;
            }

            const pr = prs.data[0];
            console.log(`Found PR #${pr.number}`);
            return pr.number;

      - name: Check PR conditions and merge
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};

            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            console.log(`PR #${prNumber} details:`);
            console.log(`- Author: ${pr.user.login}`);
            console.log(`- Branch: ${pr.head.ref}`);
            console.log(`- From fork: ${pr.head.repo.fork}`);
            console.log(`- Mergeable state: ${pr.mergeable_state}`);

            if (
              pr.user.login === 'platformsh-devrel'
              && pr.head.ref === 'update-api-doc'
              && !pr.head.repo.fork
              && pr.mergeable_state === 'clean'
            ) {
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'merge',
                  commit_title: `Merge PR #${prNumber}: Update API documentation`,
                  commit_message: `Auto-merged after all checks passed.\n\nBranch: ${pr.head.ref}\nAuthor: ${pr.user.login}`
                });

                console.log('PR merged successfully');
              } catch (error) {
                console.error('Failed to merge PR:', error.message);
                // this time we really do want to set the workflow to a failed state
                core.setFailed(error.message)
              }
            } else {
              // we don't need to fail the workflow, just state that it wasn't eligible
              console.log(`One or more requirements were not met to auto merge PR #${prNumber}`);
            }
